import"../chunks/Bzak7iHL.js";import{i as kt}from"../chunks/BvNKmLqF.js";import{p as It,o as jt,f as u,a as Ie,b as c,c as Bt,t as h,e as B,i as a,k as D,m as K,g as e,d as g,r as t,s,j as p,v as je,z as Pt,y as $t,K as Ct,x as Mt}from"../chunks/D2QV5ZPr.js";import{i as x}from"../chunks/BvOdW7jM.js";import{e as ne,i as le}from"../chunks/IKNvqO1Y.js";import{r as W}from"../chunks/CdHOzu_t.js";import{s as St}from"../chunks/Baws9BAC.js";import{b as R}from"../chunks/fy4Fdf6-.js";import{s as Dt,a as Nt}from"../chunks/GeVYpaAz.js";import{M as At}from"../chunks/DO-NYQEs.js";import{c as Ot,d as Qe,a as zt,b as qt}from"../chunks/BFtLDb_d.js";import{g as Ht}from"../chunks/BCgAnOdk.js";import{p as Lt}from"../chunks/D2SIzPNB.js";import{g as ve}from"../chunks/BqcfPq16.js";var Jt=u('<div slot="actions"><button class="p-2 rounded-lg hover:bg-black hover:bg-opacity-10 transition-colors disabled:opacity-50" aria-label="保存"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></div>'),Ut=u('<div class="bg-red-50 border border-red-200 rounded-lg p-3"><p class="text-red-600 text-sm font-medium"> </p></div>'),Et=u("<li> </li>"),Ft=u('<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3"><p class="text-yellow-800 text-sm font-medium mb-2">请检查以下问题：</p> <ul class="text-yellow-700 text-sm space-y-1"></ul></div>'),Vt=u('<div class="text-sm text-gray-600"> </div>'),Qt=u('<div class="text-sm text-gray-600"> </div>'),Tt=u('<div class="bg-gray-50 rounded-lg p-3"><div class="font-medium text-gray-900"> </div> <!> <!></div>'),Kt=u('<button class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-red-300 hover:text-red-500 transition-colors">点击选择客户</button>'),Rt=u('<p class="text-red-500 text-sm"> </p>'),Gt=u('<p class="text-red-500 text-sm mt-1"> </p>'),Wt=u('<p class="text-red-500 text-sm"> </p>'),Xt=u('<div class="text-sm text-gray-600"> </div>'),Yt=u('<button class="p-1 text-red-500 hover:bg-red-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>'),Zt=u('<div class="border border-gray-200 rounded-lg p-3"><div class="flex items-start justify-between mb-3"><div class="flex-1"><div class="font-medium text-gray-900"> </div> <!> <div class="text-sm text-gray-600"> </div></div> <div class="flex space-x-2"><button class="p-1 text-blue-500 hover:bg-blue-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button> <button class="p-1 text-green-500 hover:bg-green-50 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button> <!></div></div> <div class="grid grid-cols-3 gap-3"><div><label class="block text-xs text-gray-500 mb-1">数量</label> <input type="number" min="0" step="1" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-red-500 focus:border-transparent"/></div> <div><label class="block text-xs text-gray-500 mb-1">单价</label> <input type="number" min="0" step="0.01" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-red-500 focus:border-transparent"/></div> <div><label class="block text-xs text-gray-500 mb-1">金额</label> <div class="px-2 py-1 text-sm bg-gray-50 rounded font-medium"> </div></div></div> <div class="mt-3"><label class="block text-xs text-gray-500 mb-1">送货数量</label> <input type="number" min="0" step="1" placeholder="可选" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-red-500 focus:border-transparent"/></div></div>'),er=u('<div class="text-center py-8"><p class="text-gray-500 mb-4">还没有客户数据</p> <button class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium">添加客户</button></div>'),tr=u('<div class="text-sm text-gray-600"> </div>'),rr=u('<div class="text-xs text-blue-600"> </div>'),ar=u('<button class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition-colors border"><div class="font-medium text-gray-900"> </div> <!> <!></button>'),sr=u('<div class="space-y-2"></div>'),or=u('<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end"><div class="bg-white w-full rounded-t-lg max-h-96 overflow-y-auto"><div class="p-4 border-b border-gray-200"><div class="flex items-center justify-between"><h3 class="text-lg font-medium">选择客户</h3> <button class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div> <div class="p-4"><!></div></div></div>'),ir=u('<div class="text-center py-8"><p class="text-gray-500 mb-4">还没有产品数据</p> <button class="bg-orange-500 text-white px-4 py-2 rounded-lg font-medium">添加产品</button></div>'),dr=u('<div class="text-xs text-orange-600"> </div>'),nr=u('<div class="text-xs text-gray-500"> </div>'),lr=u('<div class="text-sm font-medium text-orange-600"> </div>'),vr=u('<button class="w-full text-left p-3 rounded-lg hover:bg-gray-100 transition-colors border"><div class="flex items-start justify-between"><div class="flex-1"><div class="font-medium text-gray-900"> </div> <!> <div class="text-sm text-gray-600"> </div> <!></div> <div class="text-right"><!></div></div></button>'),cr=u('<div class="space-y-2"></div>'),ur=u('<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end"><div class="bg-white w-full rounded-t-lg max-h-96 overflow-y-auto"><div class="p-4 border-b border-gray-200"><div class="flex items-center justify-between"><h3 class="text-lg font-medium">选择产品</h3> <button class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div> <div class="p-4"><!></div></div></div>'),mr=u('<div class="p-4 space-y-6"><!> <!> <div class="bg-white rounded-lg p-4 shadow-sm border space-y-4"><div class="flex items-center justify-between"><h3 class="font-medium text-gray-900">客户信息</h3> <button class="text-red-500 text-sm font-medium"> </button></div> <!> <!></div> <div class="bg-white rounded-lg p-4 shadow-sm border space-y-4"><h3 class="font-medium text-gray-900">基本信息</h3> <div><label class="block text-sm font-medium text-gray-700 mb-1">日期</label> <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">制单人 <span class="text-red-500">*</span></label> <input type="text" placeholder="请输入制单人"/> <!></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">送货日期</label> <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/></div></div> <div class="bg-white rounded-lg p-4 shadow-sm border space-y-4"><div class="flex items-center justify-between"><h3 class="font-medium text-gray-900">商品明细</h3> <button class="text-red-500 text-sm font-medium">+ 添加商品</button></div> <!> <div class="space-y-3"></div> <div class="border-t border-gray-200 pt-3"><div class="flex justify-between items-center"><span class="font-medium text-gray-900">合计:</span> <span class="text-xl font-bold text-red-600"> </span></div></div></div> <div class="bg-white rounded-lg p-4 shadow-sm border"><label class="block text-sm font-medium text-gray-700 mb-1">备注</label> <textarea placeholder="请输入备注信息" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"></textarea></div> <div class="flex space-x-3 pb-6"><button type="button" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-600 transition-colors">取消</button> <button type="button" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600 transition-colors disabled:opacity-50"> </button></div></div> <!> <!>',1),fr=u("<!> <!>",1);function Cr(Te,Ke){It(Ke,!1);const Be=()=>Nt(Lt,"$page",Re),[Re,Ge]=Dt();let r=K(null),ae=K([]),ce=K([]),l=K({}),X=K(!1),Y=K(!1),Z=K(!1),G=-1;const We={name:"佛山市仁腾装饰材料有限公司",address:"佛山市南海盐步大转弯夹板装饰第五期C1座12号",phone:"18575852698",email:"",taxId:""};jt(()=>{Xe(),Ye()});const Xe=()=>{try{const i=localStorage.getItem("customers");i&&D(ae,JSON.parse(i));const n=localStorage.getItem("products");n&&D(ce,JSON.parse(n))}catch(i){console.error("加载数据失败:",i)}},Ye=()=>{D(r,Ot(We));const i=Be().url.searchParams.get("customerId"),n=Be().url.searchParams.get("createdBy");if(i){const m=e(ae).find(y=>y.id===i);m&&Pe(m)}n?g(r,e(r).createdBy=decodeURIComponent(n)):g(r,e(r).createdBy=Ht())},Pe=i=>{e(r)&&(g(r,e(r).customerId=i.id),g(r,e(r).customerInfo={name:i.name,address:i.address||"",phone:i.phone,email:i.email||""}),D(Y,!1))},Ze=i=>{if(e(r)){if(G>=0){const n=e(r).items[G];n.productId=i.id,n.productName=i.name;const m=i.specifications.find(P=>P.isDefault);n.specification=m?m.name:"";const y=i.prices.find(P=>P.type==="sale"&&P.isDefault);n.unitPrice=y?y.price:0,n.unit=i.unit,ue(G)}else{const n=qt();n.productId=i.id,n.productName=i.name;const m=i.specifications.find(P=>P.isDefault);n.specification=m?m.name:"";const y=i.prices.find(P=>P.type==="sale"&&P.isDefault);n.unitPrice=y?y.price:0,n.unit=i.unit,n.amount=Qe(n.quantity,n.unitPrice),e(r).items.push(n)}D(Z,!1),G=-1,se()}},ue=i=>{if(!e(r))return;const n=e(r).items[i];n.amount=Qe(n.quantity,n.unitPrice),se()},se=()=>{e(r)&&g(r,e(r).totalAmount=zt(e(r).items))},et=()=>{G=-1,D(Z,!0)},tt=i=>{G=i,D(Z,!0)},rt=i=>{e(r)&&e(r).items.length>1&&(e(r).items.splice(i,1),se())},at=i=>{if(!e(r))return;const m={...e(r).items[i],id:crypto.randomUUID()};e(r).items.splice(i+1,0,m),se()},st=()=>{var i,n,m;return e(r)?(D(l,{}),(n=(i=e(r).customerInfo)==null?void 0:i.name)!=null&&n.trim()||g(l,e(l).customer="请选择客户"),(m=e(r).createdBy)!=null&&m.trim()||g(l,e(l).createdBy="制单人不能为空"),e(r).items.length===0&&g(l,e(l).items="至少需要一个商品项目"),e(r).items.forEach((y,P)=>{y.productName.trim()||g(l,e(l)[`item_${P}_name`]="商品名称不能为空"),y.quantity<=0&&g(l,e(l)[`item_${P}_quantity`]="数量必须大于0"),y.unitPrice<0&&g(l,e(l)[`item_${P}_price`]="单价不能为负数")}),Object.keys(e(l)).length===0):!1},$e=async(i="draft")=>{if(console.log("开始保存销售单...",{invoice:e(r),status:i}),!e(r)){console.error("保存失败：invoice 为空"),g(l,e(l).general="销售单数据未初始化");return}const n=st();if(console.log("表单验证结果:",{isValid:n,errors:e(l)}),!n){console.error("保存失败：表单验证未通过",e(l)),g(l,e(l).general="请检查并填写所有必填字段");return}D(X,!0);try{g(r,e(r).status=i),g(r,e(r).type="sale"),g(r,e(r).paymentStatus="unpaid"),g(r,e(r).paidAmount=0);const m=localStorage.getItem("invoice_history"),y=m?JSON.parse(m):[];y.push(e(r)),localStorage.setItem("invoice_history",JSON.stringify(y)),ve("/mobile/sales")}catch(m){console.error("保存销售单失败:",m),g(l,e(l).general="保存失败，请重试")}finally{D(X,!1)}},Ce=i=>`¥${i.toFixed(2)}`;kt();var Me=fr(),Se=Ie(Me);At(Se,{title:"新建销售单",showBack:!0,backgroundColor:"bg-red-500",$$slots:{actions:(i,n)=>{var m=Jt(),y=a(m);t(m),h(()=>y.disabled=e(X)),B("click",y,()=>$e("draft")),c(i,m)}}});var ot=s(Se,2);{var it=i=>{var n=mr(),m=Ie(n),y=a(m);{var P=d=>{var o=Ut(),v=a(o),k=a(v,!0);t(v),t(o),h(()=>p(k,e(l).general)),c(d,o)};x(y,d=>{e(l).general&&d(P)})}var De=s(y,2);{var dt=d=>{var o=Ft(),v=s(a(o),2);ne(v,5,()=>Object.entries(e(l)),le,(k,M)=>{var O=Ct(()=>Mt(e(M),2));let N=()=>e(O)[0],L=()=>e(O)[1];var I=$t(),$=Ie(I);{var b=_=>{var S=Et(),f=a(S);t(S),h(()=>p(f,`• ${L()??""}`)),c(_,S)};x($,_=>{N()!=="general"&&_(b)})}c(k,I)}),t(v),t(o),c(d,o)};x(De,d=>{(Object.keys(e(l)).length>1||Object.keys(e(l)).length===1&&!e(l).general)&&d(dt)})}var me=s(De,2),fe=a(me),pe=s(a(fe),2),nt=a(pe,!0);t(pe),t(fe);var Ne=s(fe,2);{var lt=d=>{var o=Tt(),v=a(o),k=a(v,!0);t(v);var M=s(v,2);{var O=I=>{var $=Vt(),b=a($,!0);t($),h(()=>p(b,e(r).customerInfo.phone)),c(I,$)};x(M,I=>{e(r).customerInfo.phone&&I(O)})}var N=s(M,2);{var L=I=>{var $=Qt(),b=a($,!0);t($),h(()=>p(b,e(r).customerInfo.address)),c(I,$)};x(N,I=>{e(r).customerInfo.address&&I(L)})}t(o),h(()=>p(k,e(r).customerInfo.name)),c(d,o)},vt=d=>{var o=Kt();B("click",o,()=>D(Y,!0)),c(d,o)};x(Ne,d=>{var o,v;(v=(o=e(r))==null?void 0:o.customerInfo)!=null&&v.name?d(lt):d(vt,!1)})}var ct=s(Ne,2);{var ut=d=>{var o=Rt(),v=a(o,!0);t(o),h(()=>p(v,e(l).customer)),c(d,o)};x(ct,d=>{e(l).customer&&d(ut)})}t(me);var be=s(me,2),ge=s(a(be),2),Ae=s(a(ge),2);W(Ae),t(ge);var _e=s(ge,2),oe=s(a(_e),2);W(oe);var mt=s(oe,2);{var ft=d=>{var o=Gt(),v=a(o,!0);t(o),h(()=>p(v,e(l).createdBy)),c(d,o)};x(mt,d=>{e(l).createdBy&&d(ft)})}t(_e);var Oe=s(_e,2),ze=s(a(Oe),2);W(ze),t(Oe),t(be);var xe=s(be,2),ye=a(xe),pt=s(a(ye),2);t(ye);var qe=s(ye,2);{var bt=d=>{var o=Wt(),v=a(o,!0);t(o),h(()=>p(v,e(l).items)),c(d,o)};x(qe,d=>{e(l).items&&d(bt)})}var he=s(qe,2);ne(he,5,()=>e(r).items,le,(d,o,v)=>{var k=Zt(),M=a(k),O=a(M),N=a(O),L=a(N,!0);t(N);var I=s(N,2);{var $=j=>{var w=Xt(),A=a(w);t(w),h(()=>p(A,`规格: ${e(o).specification??""}`)),c(j,w)};x(I,j=>{e(o).specification&&j($)})}var b=s(I,2),_=a(b);t(b),t(O);var S=s(O,2),f=a(S),z=s(f,2),U=s(z,2);{var V=j=>{var w=Yt();B("click",w,()=>rt(v)),c(j,w)};x(U,j=>{e(r).items.length>1&&j(V)})}t(S),t(M);var H=s(M,2),Q=a(H),E=s(a(Q),2);W(E),t(Q);var T=s(Q,2),C=s(a(T),2);W(C),t(T);var q=s(T,2),F=s(a(q),2),ke=a(F,!0);t(F),t(q),t(H);var ee=s(H,2),de=s(a(ee),2);W(de),t(ee),t(k),h(j=>{p(L,e(o).productName||"未选择商品"),p(_,`单位: ${e(o).unit??""}`),p(ke,j)},[()=>Ce(e(o).amount)]),B("click",f,()=>tt(v)),B("click",z,()=>at(v)),R(E,()=>e(o).quantity,j=>(e(o).quantity=j,je(()=>e(r)))),B("input",E,()=>ue(v)),R(C,()=>e(o).unitPrice,j=>(e(o).unitPrice=j,je(()=>e(r)))),B("input",C,()=>ue(v)),R(de,()=>e(o).deliveryQuantity,j=>(e(o).deliveryQuantity=j,je(()=>e(r)))),c(d,k)}),t(he);var He=s(he,2),Le=a(He),Je=s(a(Le),2),gt=a(Je,!0);t(Je),t(Le),t(He),t(xe);var we=s(xe,2),Ue=s(a(we),2);Pt(Ue),t(we);var Ee=s(we,2),Fe=a(Ee),ie=s(Fe,2),_t=a(ie,!0);t(ie),t(Ee),t(m);var Ve=s(m,2);{var xt=d=>{var o=or(),v=a(o),k=a(v),M=a(k),O=s(a(M),2);t(M),t(k);var N=s(k,2),L=a(N);{var I=b=>{var _=er(),S=s(a(_),2);t(_),B("click",S,()=>ve("/mobile/customers/new")),c(b,_)},$=b=>{var _=sr();ne(_,5,()=>e(ae),le,(S,f)=>{var z=ar(),U=a(z),V=a(U,!0);t(U);var H=s(U,2);{var Q=C=>{var q=tr(),F=a(q,!0);t(q),h(()=>p(F,e(f).phone)),c(C,q)};x(H,C=>{e(f).phone&&C(Q)})}var E=s(H,2);{var T=C=>{var q=rr(),F=a(q,!0);t(q),h(()=>p(F,e(f).category)),c(C,q)};x(E,C=>{e(f).category&&C(T)})}t(z),h(()=>p(V,e(f).name)),B("click",z,()=>Pe(e(f))),c(S,z)}),t(_),c(b,_)};x(L,b=>{e(ae).length===0?b(I):b($,!1)})}t(N),t(v),t(o),B("click",O,()=>D(Y,!1)),c(d,o)};x(Ve,d=>{e(Y)&&d(xt)})}var yt=s(Ve,2);{var ht=d=>{var o=ur(),v=a(o),k=a(v),M=a(k),O=s(a(M),2);t(M),t(k);var N=s(k,2),L=a(N);{var I=b=>{var _=ir(),S=s(a(_),2);t(_),B("click",S,()=>ve("/mobile/products/new")),c(b,_)},$=b=>{var _=cr();ne(_,5,()=>e(ce),le,(S,f)=>{var z=vr(),U=a(z),V=a(U),H=a(V),Q=a(H,!0);t(H);var E=s(H,2);{var T=w=>{var A=dr(),te=a(A,!0);t(A),h(()=>p(te,e(f).category)),c(w,A)};x(E,w=>{e(f).category&&w(T)})}var C=s(E,2),q=a(C);t(C);var F=s(C,2);{var ke=w=>{var A=nr(),te=a(A);t(A),h(J=>p(te,`规格: ${J??""}`),[()=>{var J,re;return((J=e(f).specifications.find(wt=>wt.isDefault))==null?void 0:J.name)||((re=e(f).specifications[0])==null?void 0:re.name)||"无"}]),c(w,A)};x(F,w=>{e(f).specifications.length>0&&w(ke)})}t(V);var ee=s(V,2),de=a(ee);{var j=w=>{var A=lr(),te=a(A);t(A),h(J=>p(te,`¥${J??""}`),[()=>{var J;return((J=e(f).prices.find(re=>re.type==="sale"&&re.isDefault)||e(f).prices[0])==null?void 0:J.price.toFixed(2))||"0.00"}]),c(w,A)};x(de,w=>{e(f).prices.length>0&&w(j)})}t(ee),t(U),t(z),h(()=>{p(Q,e(f).name),p(q,`单位: ${e(f).unit??""}`)}),B("click",z,()=>Ze(e(f))),c(S,z)}),t(_),c(b,_)};x(L,b=>{e(ce).length===0?b(I):b($,!1)})}t(N),t(v),t(o),B("click",O,()=>D(Z,!1)),c(d,o)};x(yt,d=>{e(Z)&&d(ht)})}h(d=>{var o,v;p(nt,(v=(o=e(r))==null?void 0:o.customerInfo)!=null&&v.name?"更换客户":"选择客户"),St(oe,1,`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent
               ${e(l).createdBy?"border-red-500":""}`),p(gt,d),ie.disabled=e(X),p(_t,e(X)?"保存中...":"保存")},[()=>Ce(e(r).totalAmount)]),B("click",pe,()=>D(Y,!0)),R(Ae,()=>e(r).date,d=>g(r,e(r).date=d)),R(oe,()=>e(r).createdBy,d=>g(r,e(r).createdBy=d)),R(ze,()=>e(r).deliveryDate,d=>g(r,e(r).deliveryDate=d)),B("click",pt,et),R(Ue,()=>e(r).notes,d=>g(r,e(r).notes=d)),B("click",Fe,()=>ve("/mobile/sales")),B("click",ie,()=>$e("draft")),c(i,n)};x(ot,i=>{e(r)&&i(it)})}c(Te,Me),Bt(),Ge()}export{Cr as component};
