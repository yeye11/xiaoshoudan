# 销售管理系统 - 服务端架构设计文档

## 📋 文档概述

本文档为 **Cypridina 销售管理系统** 的服务端架构设计，包括功能需求、技术栈选择、系统架构、数据库设计等内容。

---

## 🎯 项目定位

- **应用类型**: SaaS 销售管理系统
- **客户端**: Tauri + SvelteKit 移动应用
- **服务端**: RESTful API + 数据库
- **用户类型**: 中小企业销售团队
- **核心功能**: 销售单、客户、产品、库存、报表管理

---

## 📊 核心功能模块

### 1️⃣ **用户认证与授权**
- ✅ 用户注册 / 登录 / 登出
- ✅ 密码重置 / 修改
- ✅ JWT Token 认证
- ✅ 角色权限管理 (Admin / Manager / Salesman)
- ✅ 多设备登录管理

### 2️⃣ **销售管理**
- ✅ 销售单创建 / 编辑 / 删除 / 查询
- ✅ 销售单状态管理 (草稿 / 已提交 / 已完成 / 已取消)
- ✅ 销售单审核流程
- ✅ 销售单导出 (PDF / Excel)
- ✅ 销售统计 (按日期 / 客户 / 产品)

### 3️⃣ **客户管理**
- ✅ 客户信息管理 (基本信息 / 联系方式 / 分类)
- ✅ 客户分类标签
- ✅ 客户销售历史查询
- ✅ 客户信用额度管理
- ✅ 客户黑名单管理

### 4️⃣ **产品管理**
- ✅ 产品信息管理 (名称 / 规格 / 单价 / 库存)
- ✅ 产品分类管理
- ✅ 产品标签管理
- ✅ 库存预警设置
- ✅ 产品销售排行

### 5️⃣ **库存管理**
- ✅ 库存实时查询
- ✅ 库存出入库记录
- ✅ 库存预警通知
- ✅ 库存盘点
- ✅ 库存成本计算

### 6️⃣ **报表与分析**
- ✅ 销售报表 (日 / 周 / 月 / 年)
- ✅ 客户分析 (消费金额 / 购买频率)
- ✅ 产品分析 (销售量 / 销售额)
- ✅ 员工绩效报表
- ✅ 数据导出 (Excel / PDF)

### 7️⃣ **财务管理**
- ✅ 应收账款管理
- ✅ 收款记录
- ✅ 发票管理
- ✅ 财务报表
- ✅ 对账单

### 8️⃣ **系统管理**
- ✅ 用户管理
- ✅ 角色权限管理
- ✅ 操作日志
- ✅ 数据备份
- ✅ 系统设置

---

## 🛠️ 技术栈选择

### 推荐方案：**Node.js + Express + PostgreSQL**

#### 为什么选择 Node.js？

| 对比项 | Node.js | Python | Go |
|--------|---------|--------|-----|
| **开发速度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| **学习曲线** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **性能** | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **生态系统** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **前后端统一** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐ |
| **部署简单性** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **成本** | 低 | 低 | 低 |

#### 技术栈详情

```
后端框架: Express.js / Fastify
├── 路由: Express Router
├── 中间件: CORS, JWT, 日志, 错误处理
├── 验证: Joi / Zod
└── 文档: Swagger/OpenAPI

数据库: PostgreSQL
├── ORM: Sequelize / TypeORM / Prisma
├── 迁移: db-migrate / Sequelize CLI
└── 连接池: pg-pool

认证: JWT + Refresh Token
├── 密码加密: bcrypt
├── Token 签名: jsonwebtoken
└── 会话管理: Redis (可选)

文件处理: 
├── 上传: multer
├── 导出: xlsx / pdfkit
└── 存储: 本地 / AWS S3 / 阿里云 OSS

缓存: Redis
├── 会话缓存
├── 数据缓存
└── 队列: Bull / RabbitMQ

监控日志:
├── 日志: Winston / Pino
├── 监控: PM2 / New Relic
└── 错误追踪: Sentry

部署:
├── 容器: Docker
├── 编排: Docker Compose / Kubernetes
└── 云平台: AWS / 阿里云 / 腾讯云
```

---

## 🏗️ 系统架构

### 分层架构

```
┌─────────────────────────────────────┐
│      客户端 (Tauri + SvelteKit)      │
└──────────────┬──────────────────────┘
               │ HTTP/HTTPS
┌──────────────▼──────────────────────┐
│         API Gateway / 负载均衡        │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Express.js 应用服务器           │
├─────────────────────────────────────┤
│ ├─ 路由层 (Routes)                  │
│ ├─ 控制层 (Controllers)             │
│ ├─ 业务层 (Services)                │
│ ├─ 数据层 (Models/Repositories)     │
│ └─ 中间件 (Middleware)              │
└──────────────┬──────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼──┐  ┌───▼──┐  ┌───▼──┐
│ 数据库 │  │ 缓存  │  │ 队列  │
│  PG   │  │Redis │  │ Bull  │
└───────┘  └───────┘  └───────┘
```

---

## 💾 数据库设计

### 核心表结构

```sql
-- 用户表
users (id, email, password, name, role, status, created_at)

-- 销售单表
sales_invoices (id, invoice_no, user_id, customer_id, date, total, status)

-- 销售单明细表
sales_items (id, invoice_id, product_id, quantity, unit_price, amount)

-- 客户表
customers (id, name, phone, email, category, credit_limit, status)

-- 产品表
products (id, name, sku, category, unit_price, stock, status)

-- 库存表
inventory (id, product_id, quantity, reserved, available)

-- 库存日志表
inventory_logs (id, product_id, type, quantity, reason, created_at)

-- 收款记录表
payments (id, invoice_id, amount, method, status, created_at)

-- 操作日志表
audit_logs (id, user_id, action, resource, changes, created_at)
```

---

## 🔐 安全性考虑

- ✅ HTTPS 加密传输
- ✅ JWT Token 认证
- ✅ 密码加密存储 (bcrypt)
- ✅ SQL 注入防护 (参数化查询)
- ✅ CORS 跨域配置
- ✅ 速率限制 (Rate Limiting)
- ✅ 输入验证 (Input Validation)
- ✅ 操作日志审计
- ✅ 数据备份与恢复

---

## 📈 性能优化

- ✅ 数据库索引优化
- ✅ 查询结果缓存 (Redis)
- ✅ 分页查询
- ✅ 异步处理 (队列)
- ✅ CDN 加速 (静态资源)
- ✅ 数据库连接池
- ✅ API 响应压缩 (gzip)

---

## 🚀 部署方案

### 开发环境
```bash
npm install
npm run dev
```

### 生产环境
```bash
# Docker 部署
docker-compose up -d

# 或 PM2 部署
pm2 start app.js --name "sales-api"
```

### 云平台推荐
- **国内**: 阿里云 / 腾讯云 / 华为云
- **国外**: AWS / Google Cloud / Azure
- **容器**: Docker + Kubernetes

---

## 📅 开发计划

### Phase 1: 基础架构 (2-3周)
- [ ] 项目初始化
- [ ] 数据库设计与迁移
- [ ] 用户认证系统
- [ ] 基础 CRUD API

### Phase 2: 核心功能 (3-4周)
- [ ] 销售单管理
- [ ] 客户管理
- [ ] 产品管理
- [ ] 库存管理

### Phase 3: 高级功能 (2-3周)
- [ ] 报表与分析
- [ ] 财务管理
- [ ] 数据导出
- [ ] 权限管理

### Phase 4: 优化与部署 (1-2周)
- [ ] 性能优化
- [ ] 安全加固
- [ ] 测试覆盖
- [ ] 生产部署

---

## 📞 下一步行动

1. **确认技术栈** - 是否同意使用 Node.js + Express + PostgreSQL？
2. **数据库设计** - 需要详细的 ER 图和表结构设计
3. **API 文档** - 需要完整的 API 接口文档
4. **认证方案** - 确定用户认证和授权的具体实现
5. **部署方案** - 选择云平台和部署方式

---

## 📚 参考资源

- Express.js 官方文档: https://expressjs.com/
- PostgreSQL 官方文档: https://www.postgresql.org/docs/
- JWT 认证: https://jwt.io/
- RESTful API 设计: https://restfulapi.net/
- Node.js 最佳实践: https://github.com/goldbergyoni/nodebestpractices

