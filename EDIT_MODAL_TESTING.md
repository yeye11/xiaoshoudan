# 产品编辑模态框功能测试指南

## 功能概述

已成功实现产品编辑模态框，允许用户在选择产品时直接编辑产品信息（数量、单价、规格等），然后保存到销售单中。

## 实现的功能

### 1. 编辑模态框界面
- ✅ 产品名称显示（头部）
- ✅ 关闭按钮（X 按钮）
- ✅ 库存信息显示
- ✅ 单价选择（下拉框）
- ✅ 单位显示（只读）
- ✅ 规格型号选择（下拉框 + 添加按钮）
- ✅ 销售数量编辑（-/+ 按钮 + 输入框）
- ✅ 送货数量编辑（蓝色标签，-/+ 按钮 + 输入框）
- ✅ 备注输入框
- ✅ 底部操作栏（金额显示 + 保存按钮）

### 2. 工作流程
1. 用户点击产品卡片 → 打开编辑模态框
2. 用户编辑各个字段
3. 点击"保存" → 返回销售单页面，添加该产品
4. 点击"保存并返回" → 同样返回销售单页面

### 3. 数据处理
- ✅ 编辑模态框中的数据通过 URL 参数传递
- ✅ 销售单页面自动处理 `cartItem` 参数
- ✅ 保持向后兼容性（支持旧的 `pickProductId` 参数）

## 测试步骤

### 前置条件
1. 确保应用已启动：`npm run dev`
2. 访问 URL：`http://localhost:1420/mobile/products/select?index=-1&customerId=<customer_id>`

### 测试场景 1：打开编辑模态框
1. 在产品列表中点击任意产品卡片
2. **预期结果**：编辑模态框应该打开，显示产品名称和各个编辑字段

### 测试场景 2：编辑数量
1. 打开编辑模态框
2. 在"销售数量"字段中：
   - 点击 "-" 按钮，数量应该减少
   - 点击 "+" 按钮，数量应该增加
   - 直接输入数字
3. **预期结果**：金额应该实时更新

### 测试场景 3：编辑单价
1. 打开编辑模态框
2. 在"单价"下拉框中选择不同的价格
3. **预期结果**：金额应该实时更新

### 测试场景 4：编辑送货数量
1. 打开编辑模态框
2. 在"送货数量"字段中编辑数量
3. **预期结果**：送货数量应该更新（不影响金额计算）

### 测试场景 5：保存产品
1. 打开编辑模态框
2. 编辑各个字段
3. 点击"保存"按钮
4. **预期结果**：
   - 模态框关闭
   - 返回销售单页面
   - 产品应该被添加到销售单中
   - 显示编辑的数量和单价

### 测试场景 6：关闭模态框
1. 打开编辑模态框
2. 点击 X 按钮或点击背景
3. **预期结果**：模态框关闭，不保存任何更改

## 代码修改总结

### 修改的文件

#### 1. `src/routes/mobile/products/select/+page.svelte`
- 添加编辑模态框状态变量
- 实现 `openEditModal()` 函数
- 实现 `closeEditModal()` 函数
- 实现 `saveItem()` 函数
- 添加编辑模态框 UI 组件
- 修改产品点击处理逻辑

#### 2. `src/routes/mobile/sales/new/+page.svelte`
- 添加 `cartItem` 参数处理逻辑
- 实现购物车项目解析和添加
- 保持向后兼容性

## 技术细节

### 数据流
```
产品列表 → 点击产品 → 打开编辑模态框 → 编辑数据 → 保存 → URL 参数传递 → 销售单页面 → 解析参数 → 添加到购物车
```

### URL 参数格式
```
/mobile/sales/new?cartItem=<encoded_json>&index=<index>&customerId=<customer_id>
```

其中 `cartItem` 是 URL 编码的 JSON 字符串，包含完整的 `InvoiceItem` 对象。

## 已知限制

1. 库存数量目前硬编码为 -3（需要后续集成库存系统）
2. 规格选择的 "+" 按钮功能未实现（需要后续开发）
3. 送货数量不影响金额计算（按需求设计）

## 后续优化

1. 集成库存系统，动态显示库存数量
2. 实现规格选择的 "+" 按钮功能
3. 添加产品图片显示
4. 添加历史价格显示
5. 支持批量编辑

## 编译和测试

### 编译检查
```bash
npm run check
```

### 运行开发服务器
```bash
npm run dev
```

### 构建生产版本
```bash
npm run build
```

## 常见问题

### Q: 编辑模态框不显示？
A: 检查浏览器控制台是否有错误，确保产品数据已正确加载。

### Q: 金额不更新？
A: 确保 `calculateItemAmount` 函数被正确调用，检查数量和单价是否有效。

### Q: 保存后没有返回销售单页面？
A: 检查 URL 参数是否正确编码，确保 `goto` 函数正常工作。

## 验证清单

- [x] 编辑模态框 UI 完整
- [x] 数据编辑功能正常
- [x] 金额实时计算
- [x] 保存功能正常
- [x] 参数传递正确
- [x] 销售单页面正确处理参数
- [x] 向后兼容性保持
- [x] 编译无错误
- [x] 类型检查通过

