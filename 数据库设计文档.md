# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ•°æ®åº“æ¦‚è¿°

- **æ•°æ®åº“ç³»ç»Ÿ**: PostgreSQL 12+
- **å­—ç¬¦é›†**: UTF-8
- **æ—¶åŒº**: UTC
- **ORM**: Prisma / TypeORM / Sequelize

---

## ğŸ“Š ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤ sales_invoices
â”‚             â”‚         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                         â”‚ sales_items â”‚
                         â”‚             â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   products    â”‚
                         â”‚               â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  customers   â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  inventory   â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ audit_logs   â”‚
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‘ è¡¨ç»“æ„è¯¦è§£

### 1. users (ç”¨æˆ·è¡¨)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  company_id UUID,
  role VARCHAR(50) DEFAULT 'salesman', -- admin, manager, salesman
  status VARCHAR(50) DEFAULT 'active', -- active, inactive, suspended
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  
  INDEX idx_email (email),
  INDEX idx_company_id (company_id),
  INDEX idx_status (status)
);
```

### 2. customers (å®¢æˆ·è¡¨)

```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  email VARCHAR(100),
  category VARCHAR(50), -- VIP, æ™®é€š, æ½œåœ¨
  credit_limit DECIMAL(12, 2) DEFAULT 0,
  credit_used DECIMAL(12, 2) DEFAULT 0,
  address TEXT,
  remark TEXT,
  status VARCHAR(50) DEFAULT 'active', -- active, inactive, blacklist
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (created_by) REFERENCES users(id),
  INDEX idx_company_id (company_id),
  INDEX idx_status (status),
  INDEX idx_name (name)
);
```

### 3. products (äº§å“è¡¨)

```sql
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  name VARCHAR(100) NOT NULL,
  sku VARCHAR(50) UNIQUE NOT NULL,
  category VARCHAR(50),
  unit VARCHAR(20), -- ä»¶, ç›’, ç®±ç­‰
  unit_price DECIMAL(12, 2) NOT NULL,
  cost_price DECIMAL(12, 2),
  specs TEXT, -- è§„æ ¼è¯´æ˜
  description TEXT,
  status VARCHAR(50) DEFAULT 'active',
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (created_by) REFERENCES users(id),
  INDEX idx_company_id (company_id),
  INDEX idx_sku (sku),
  INDEX idx_category (category)
);
```

### 4. sales_invoices (é”€å”®å•è¡¨)

```sql
CREATE TABLE sales_invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  invoice_no VARCHAR(50) UNIQUE NOT NULL,
  customer_id UUID NOT NULL,
  user_id UUID NOT NULL,
  invoice_date DATE NOT NULL,
  total_amount DECIMAL(12, 2) NOT NULL,
  discount_amount DECIMAL(12, 2) DEFAULT 0,
  final_amount DECIMAL(12, 2) NOT NULL,
  status VARCHAR(50) DEFAULT 'draft', -- draft, submitted, approved, completed, cancelled
  payment_status VARCHAR(50) DEFAULT 'unpaid', -- unpaid, partial, paid
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (customer_id) REFERENCES customers(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_company_id (company_id),
  INDEX idx_customer_id (customer_id),
  INDEX idx_invoice_date (invoice_date),
  INDEX idx_status (status),
  INDEX idx_invoice_no (invoice_no)
);
```

### 5. sales_items (é”€å”®å•æ˜ç»†è¡¨)

```sql
CREATE TABLE sales_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invoice_id UUID NOT NULL,
  product_id UUID NOT NULL,
  quantity DECIMAL(10, 2) NOT NULL,
  unit_price DECIMAL(12, 2) NOT NULL,
  discount_rate DECIMAL(5, 2) DEFAULT 0, -- æŠ˜æ‰£ç‡ %
  line_amount DECIMAL(12, 2) NOT NULL,
  remark TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (invoice_id) REFERENCES sales_invoices(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id),
  INDEX idx_invoice_id (invoice_id),
  INDEX idx_product_id (product_id)
);
```

### 6. inventory (åº“å­˜è¡¨)

```sql
CREATE TABLE inventory (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  product_id UUID NOT NULL,
  quantity DECIMAL(10, 2) NOT NULL DEFAULT 0,
  reserved DECIMAL(10, 2) NOT NULL DEFAULT 0, -- å·²é¢„ç•™
  available DECIMAL(10, 2) GENERATED ALWAYS AS (quantity - reserved) STORED,
  warning_level DECIMAL(10, 2) DEFAULT 0, -- é¢„è­¦åº“å­˜
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (product_id) REFERENCES products(id),
  UNIQUE (company_id, product_id),
  INDEX idx_company_id (company_id),
  INDEX idx_product_id (product_id)
);
```

### 7. inventory_logs (åº“å­˜æ—¥å¿—è¡¨)

```sql
CREATE TABLE inventory_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  product_id UUID NOT NULL,
  type VARCHAR(50), -- in, out, adjust, return
  quantity DECIMAL(10, 2) NOT NULL,
  reason VARCHAR(100),
  reference_id UUID, -- å…³è”é”€å”®å•ç­‰
  reference_type VARCHAR(50), -- sales_invoice, purchase_orderç­‰
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (product_id) REFERENCES products(id),
  FOREIGN KEY (created_by) REFERENCES users(id),
  INDEX idx_company_id (company_id),
  INDEX idx_product_id (product_id),
  INDEX idx_created_at (created_at)
);
```

### 8. payments (æ”¶æ¬¾è®°å½•è¡¨)

```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  invoice_id UUID NOT NULL,
  amount DECIMAL(12, 2) NOT NULL,
  payment_method VARCHAR(50), -- cash, bank_transfer, checkç­‰
  payment_date DATE NOT NULL,
  reference_no VARCHAR(100), -- æ”¯ç¥¨å·ã€è½¬è´¦å·ç­‰
  status VARCHAR(50) DEFAULT 'completed',
  remark TEXT,
  created_by UUID NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (invoice_id) REFERENCES sales_invoices(id),
  FOREIGN KEY (created_by) REFERENCES users(id),
  INDEX idx_company_id (company_id),
  INDEX idx_invoice_id (invoice_id),
  INDEX idx_payment_date (payment_date)
);
```

### 9. audit_logs (æ“ä½œæ—¥å¿—è¡¨)

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL,
  user_id UUID NOT NULL,
  action VARCHAR(50), -- create, update, delete, exportç­‰
  resource_type VARCHAR(50), -- sales_invoice, customer, productç­‰
  resource_id UUID,
  changes JSONB, -- å˜æ›´å†…å®¹
  ip_address VARCHAR(50),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (company_id) REFERENCES companies(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_company_id (company_id),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  INDEX idx_resource (resource_type, resource_id)
);
```

### 10. companies (å…¬å¸è¡¨)

```sql
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  license_no VARCHAR(50) UNIQUE,
  phone VARCHAR(20),
  email VARCHAR(100),
  address TEXT,
  subscription_plan VARCHAR(50), -- free, basic, pro, enterprise
  subscription_status VARCHAR(50) DEFAULT 'active',
  subscription_expires_at TIMESTAMP,
  max_users INT DEFAULT 5,
  max_products INT DEFAULT 1000,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_subscription_status (subscription_status)
);
```

---

## ğŸ”‘ ç´¢å¼•ç­–ç•¥

### å¸¸ç”¨æŸ¥è¯¢ç´¢å¼•
```sql
-- é”€å”®å•æŸ¥è¯¢
CREATE INDEX idx_sales_invoices_company_date 
ON sales_invoices(company_id, invoice_date DESC);

-- å®¢æˆ·é”€å”®å†å²
CREATE INDEX idx_sales_invoices_customer 
ON sales_invoices(customer_id, invoice_date DESC);

-- äº§å“é”€å”®ç»Ÿè®¡
CREATE INDEX idx_sales_items_product 
ON sales_items(product_id, created_at DESC);

-- åº“å­˜é¢„è­¦
CREATE INDEX idx_inventory_warning 
ON inventory(company_id, available) 
WHERE available < warning_level;
```

---

## ğŸ” æ•°æ®å®‰å…¨

- âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†
- âœ… æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- âœ… æ“ä½œæ—¥å¿—å®Œæ•´è®°å½•
- âœ… è½¯åˆ é™¤ (deleted_at)
- âœ… å¤šç§Ÿæˆ·éš”ç¦» (company_id)

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- âœ… åˆç†ä½¿ç”¨ç´¢å¼•
- âœ… åˆ†åŒºè¡¨ (å¤§æ•°æ®é‡)
- âœ… ç‰©åŒ–è§†å›¾ (æŠ¥è¡¨æ•°æ®)
- âœ… å®šæœŸç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯
- âœ… è¿æ¥æ± é…ç½®

---

## ğŸ”„ æ•°æ®è¿ç§»

```bash
# ä½¿ç”¨ Prisma è¿ç§»
npx prisma migrate dev --name init

# ä½¿ç”¨ Sequelize è¿ç§»
npx sequelize-cli db:migrate

# ä½¿ç”¨ TypeORM è¿ç§»
npm run typeorm migration:run
```

