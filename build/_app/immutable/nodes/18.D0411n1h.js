import"../chunks/Bzak7iHL.js";import{i as bt}from"../chunks/BvNKmLqF.js";import{p as pt,m as B,o as gt,f as l,a as ye,b as v,c as ft,t as w,e as k,i as a,k as p,g as e,d as m,r,s as o,z as _t,j as _,v as Je}from"../chunks/D2QV5ZPr.js";import{i as I}from"../chunks/BvOdW7jM.js";import{e as he,i as we}from"../chunks/IKNvqO1Y.js";import{r as re}from"../chunks/CdHOzu_t.js";import{b as Q}from"../chunks/fy4Fdf6-.js";import{s as xt,a as yt}from"../chunks/GeVYpaAz.js";import{M as ht}from"../chunks/DO-NYQEs.js";import{c as wt,j as ke,b as kt}from"../chunks/BFtLDb_d.js";import{p as It}from"../chunks/D2SIzPNB.js";import{g as ie}from"../chunks/BqcfPq16.js";var jt=l('<div slot="actions"><button class="p-2 rounded-lg hover:bg-black hover:bg-opacity-10 transition-colors disabled:opacity-50" aria-label="保存"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></div>'),Pt=l('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500 mx-auto"></div> <p class="text-gray-500 mt-2">加载中...</p></div>'),St=l('<div class="bg-red-50 border border-red-200 rounded-lg p-3"><p class="text-red-600 text-sm"> </p></div>'),Mt=l('<div class="text-sm text-gray-600"> </div>'),Ct=l('<div class="text-sm text-gray-600"> </div>'),Nt=l('<div class="bg-gray-50 rounded-lg p-3"><div class="font-medium text-gray-900"> </div> <!> <!></div>'),$t=l('<div class="text-center py-4 text-gray-500"><p>请选择客户</p></div>'),Bt=l('<p class="text-red-500 text-sm"> </p>'),Ot=l('<p class="text-sm text-gray-600"> </p>'),qt=l('<div class="border border-gray-200 rounded-lg p-3"><div class="flex items-start justify-between mb-2"><div class="flex-1"><h4 class="font-medium text-gray-900"> </h4> <!></div> <div class="flex space-x-1 ml-2"><button class="p-1 text-blue-600 hover:bg-blue-50 rounded" aria-label="编辑"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button> <button class="p-1 text-green-600 hover:bg-green-50 rounded" aria-label="复制"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button> <button class="p-1 text-red-600 hover:bg-red-50 rounded" aria-label="删除"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div> <div class="grid grid-cols-3 gap-2"><div><label class="block text-xs text-gray-500 mb-1">数量</label> <input type="number" min="0" step="0.01" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-red-500 focus:border-transparent"/></div> <div><label class="block text-xs text-gray-500 mb-1">单价</label> <input type="number" min="0" step="0.01" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-red-500 focus:border-transparent"/></div> <div><label class="block text-xs text-gray-500 mb-1">金额</label> <div class="px-2 py-1 text-sm bg-gray-50 rounded border"> </div></div></div></div>'),zt=l('<div class="space-y-3"></div> <div class="border-t border-gray-200 pt-3"><div class="flex justify-between items-center"><span class="font-medium text-gray-900">合计:</span> <span class="text-xl font-bold text-red-600"> </span></div></div>',1),Dt=l('<div class="text-center py-8 text-gray-500"><p>暂无商品，请添加商品</p></div>'),At=l('<p class="text-red-500 text-sm"> </p>'),Ht=l('<!> <div class="bg-white rounded-lg p-4 shadow-sm border space-y-4"><h3 class="font-medium text-gray-900">基本信息</h3> <div><label class="block text-sm font-medium text-gray-700 mb-1">销售单号</label> <input type="text" placeholder="自动生成" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" readonly=""/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">日期</label> <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/></div> <div><label class="block text-sm font-medium text-gray-700 mb-1">送货日期</label> <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/></div></div> <div class="bg-white rounded-lg p-4 shadow-sm border space-y-4"><div class="flex items-center justify-between"><h3 class="font-medium text-gray-900">客户信息</h3> <button class="text-red-600 text-sm font-medium hover:text-red-700">选择客户</button></div> <!> <!></div> <div class="bg-white rounded-lg p-4 shadow-sm border space-y-4"><div class="flex items-center justify-between"><h3 class="font-medium text-gray-900">商品明细</h3> <button class="bg-red-500 text-white px-3 py-1 rounded text-sm font-medium hover:bg-red-600 transition-colors">添加商品</button></div> <!> <!></div> <div class="bg-white rounded-lg p-4 shadow-sm border"><label class="block text-sm font-medium text-gray-700 mb-1">备注</label> <textarea placeholder="请输入备注信息" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"></textarea></div> <div class="flex space-x-3 pb-6"><button type="button" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-medium hover:bg-gray-600 transition-colors">取消</button> <button type="button" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600 transition-colors disabled:opacity-50"> </button></div>',1),Jt=l('<div class="text-sm text-gray-600"> </div>'),Lt=l('<div class="text-sm text-gray-600"> </div>'),Ft=l('<button class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors"><div class="font-medium text-gray-900"> </div> <!> <!></button>'),Et=l('<div class="space-y-2"></div>'),Vt=l('<div class="text-center py-8 text-gray-500"><p>暂无客户数据</p> <button class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors">添加客户</button></div>'),Tt=l('<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end"><div class="bg-white w-full rounded-t-lg max-h-96 overflow-y-auto"><div class="p-4 border-b border-gray-200"><div class="flex items-center justify-between"><h3 class="text-lg font-medium">选择客户</h3> <button class="text-gray-400 hover:text-gray-600" aria-label="关闭"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div> <div class="p-4"><!></div></div></div>'),Gt=l('<div class="text-xs text-gray-500"> </div>'),Kt=l('<button class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors"><div class="font-medium text-gray-900"> </div> <div class="text-sm text-gray-600"> </div> <!></button>'),Qt=l('<div class="space-y-2"></div>'),Rt=l('<div class="text-center py-8 text-gray-500"><p>暂无产品数据</p> <button class="mt-2 bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition-colors">添加产品</button></div>'),Ut=l('<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end"><div class="bg-white w-full rounded-t-lg max-h-96 overflow-y-auto"><div class="p-4 border-b border-gray-200"><div class="flex items-center justify-between"><h3 class="text-lg font-medium">选择产品</h3> <button class="text-gray-400 hover:text-gray-600" aria-label="关闭"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div></div> <div class="p-4"><!></div></div></div>'),Wt=l('<!> <div class="p-4 space-y-6"><!></div> <!> <!>',1);function vr(Le,Fe){pt(Fe,!1);const Ee=()=>yt(It,"$page",Ve),[Ve,Te]=xt();let s=B(wt()),de=B([]),ne=B([]),n=B({}),R=B(!1),U=B(),Ie=B(!0),ae=B(!1),W=B(!1),A=B(-1);gt(()=>{p(U,Ee().params.id),Ge()});const Ge=async()=>{try{const t=localStorage.getItem("customers");t&&p(de,JSON.parse(t));const i=localStorage.getItem("products");i&&p(ne,JSON.parse(i));const c=localStorage.getItem("invoice_history");if(c){const j=JSON.parse(c).find(f=>f.id===e(U));j?p(s,{...j}):m(n,e(n).general="销售单不存在")}else m(n,e(n).general="没有找到销售单数据")}catch(t){console.error("加载数据失败:",t),m(n,e(n).general="加载数据失败")}finally{p(Ie,!1)}},Ke=t=>{m(s,e(s).customerId=t.id),m(s,e(s).customerInfo={name:t.name,address:t.address||"",phone:t.phone,email:t.email||""}),p(ae,!1)},Qe=t=>{var i,c,g,j;if(e(A)>=0)m(s,e(s).items[e(A)]={...e(s).items[e(A)],productId:t.id,productName:t.name,specification:((c=(i=t.specifications)==null?void 0:i[0])==null?void 0:c.name)||"",unit:t.unit,unitPrice:ke(t,"sale")});else{const f=kt();f.productId=t.id,f.productName=t.name,f.specification=((j=(g=t.specifications)==null?void 0:g[0])==null?void 0:j.name)||"",f.unit=t.unit,f.unitPrice=ke(t,"sale"),f.quantity=1,m(s,e(s).items=[...e(s).items,f])}V(),p(W,!1),p(A,-1)},Re=()=>{p(A,-1),p(W,!0)},Ue=t=>{p(A,t),p(W,!0)},We=t=>{m(s,e(s).items=e(s).items.filter((i,c)=>c!==t)),V()},Xe=t=>{const i={...e(s).items[t]};i.id=Date.now().toString(),m(s,e(s).items=[...e(s).items,i]),V()},V=()=>{m(s,e(s).totalAmount=e(s).items.reduce((t,i)=>(i.amount=i.quantity*i.unitPrice,t+i.amount),0))},Ye=()=>{p(n,{}),e(s).customerInfo.name.trim()||m(n,e(n).customer="请选择客户"),e(s).items.length===0&&m(n,e(n).items="请至少添加一个商品");for(let t=0;t<e(s).items.length;t++){const i=e(s).items[t];i.productName.trim()||m(n,e(n)[`item_${t}_name`]="商品名称不能为空"),i.quantity<=0&&m(n,e(n)[`item_${t}_quantity`]="数量必须大于0"),i.unitPrice<0&&m(n,e(n)[`item_${t}_price`]="单价不能为负数")}return Object.keys(e(n)).length===0},je=async()=>{if(Ye()){p(R,!0);try{m(s,e(s).updatedAt=new Date().toISOString()),V();const t=localStorage.getItem("invoice_history"),i=t?JSON.parse(t):[],c=i.findIndex(g=>g.id===e(U));c>=0?(i[c]=e(s),localStorage.setItem("invoice_history",JSON.stringify(i)),ie(`/mobile/sales/${e(U)}`)):m(n,e(n).general="销售单不存在")}catch(t){console.error("保存销售单失败:",t),m(n,e(n).general="保存失败，请重试")}finally{p(R,!1)}}},Pe=t=>`¥${t.toFixed(2)}`;bt();var Se=Wt(),Me=ye(Se);ht(Me,{title:"编辑销售单",showBack:!0,backgroundColor:"bg-red-500",$$slots:{actions:(t,i)=>{var c=jt(),g=a(c);r(c),w(()=>g.disabled=e(R)),k("click",g,je),v(t,c)}}});var ve=o(Me,2),Ze=a(ve);{var et=t=>{var i=Pt();v(t,i)},tt=t=>{var i=Ht(),c=ye(i);{var g=d=>{var u=St(),M=a(u),K=a(M,!0);r(M),r(u),w(()=>_(K,e(n).general)),v(d,u)};I(c,d=>{e(n).general&&d(g)})}var j=o(c,2),f=o(a(j),2),z=o(a(f),2);re(z),r(f);var H=o(f,2),T=o(a(H),2);re(T),r(H);var G=o(H,2),x=o(a(G),2);re(x),r(G),r(j);var b=o(j,2),N=a(b),y=o(a(N),2);r(N);var C=o(N,2);{var O=d=>{var u=Nt(),M=a(u),K=a(M,!0);r(M);var ee=o(M,2);{var oe=h=>{var $=Mt(),E=a($,!0);r($),w(()=>_(E,e(s).customerInfo.phone)),v(h,$)};I(ee,h=>{e(s).customerInfo.phone&&h(oe)})}var ce=o(ee,2);{var te=h=>{var $=Ct(),E=a($,!0);r($),w(()=>_(E,e(s).customerInfo.address)),v(h,$)};I(ce,h=>{e(s).customerInfo.address&&h(te)})}r(u),w(()=>_(K,e(s).customerInfo.name)),v(d,u)},X=d=>{var u=$t();v(d,u)};I(C,d=>{e(s).customerInfo.name?d(O):d(X,!1)})}var D=o(C,2);{var Y=d=>{var u=Bt(),M=a(u,!0);r(u),w(()=>_(M,e(n).customer)),v(d,u)};I(D,d=>{e(n).customer&&d(Y)})}r(b);var J=o(b,2),L=a(J),P=o(a(L),2);r(L);var S=o(L,2);{var F=d=>{var u=zt(),M=ye(u);he(M,5,()=>e(s).items,we,(te,h,$)=>{var E=qt(),ue=a(E),me=a(ue),be=a(me),nt=a(be,!0);r(be);var vt=o(be,2);{var lt=q=>{var xe=Ot(),mt=a(xe);r(xe),w(()=>_(mt,`规格: ${e(h).specification??""}`)),v(q,xe)};I(vt,q=>{e(h).specification&&q(lt)})}r(me);var Oe=o(me,2),qe=a(Oe),ze=o(qe,2),ct=o(ze,2);r(Oe),r(ue);var De=o(ue,2),pe=a(De),ge=o(a(pe),2);re(ge),r(pe);var fe=o(pe,2),_e=o(a(fe),2);re(_e),r(fe);var Ae=o(fe,2),He=o(a(Ae),2),ut=a(He,!0);r(He),r(Ae),r(De),r(E),w(q=>{_(nt,e(h).productName),_(ut,q)},[()=>Pe(e(h).amount||0)]),k("click",qe,()=>Ue($)),k("click",ze,()=>Xe($)),k("click",ct,()=>We($)),Q(ge,()=>e(h).quantity,q=>(e(h).quantity=q,Je(()=>e(s)))),k("input",ge,V),Q(_e,()=>e(h).unitPrice,q=>(e(h).unitPrice=q,Je(()=>e(s)))),k("input",_e,V),v(te,E)}),r(M);var K=o(M,2),ee=a(K),oe=o(a(ee),2),ce=a(oe,!0);r(oe),r(ee),r(K),w(te=>_(ce,te),[()=>Pe(e(s).totalAmount)]),v(d,u)},Z=d=>{var u=Dt();v(d,u)};I(S,d=>{e(s).items.length>0?d(F):d(Z,!1)})}var ot=o(S,2);{var it=d=>{var u=At(),M=a(u,!0);r(u),w(()=>_(M,e(n).items)),v(d,u)};I(ot,d=>{e(n).items&&d(it)})}r(J);var le=o(J,2),Ne=o(a(le),2);_t(Ne),r(le);var $e=o(le,2),Be=a($e),se=o(Be,2),dt=a(se,!0);r(se),r($e),w(()=>{se.disabled=e(R),_(dt,e(R)?"保存中...":"保存")}),Q(z,()=>e(s).invoiceNumber,d=>m(s,e(s).invoiceNumber=d)),Q(T,()=>e(s).date,d=>m(s,e(s).date=d)),Q(x,()=>e(s).deliveryDate,d=>m(s,e(s).deliveryDate=d)),k("click",y,()=>p(ae,!0)),k("click",P,Re),Q(Ne,()=>e(s).notes,d=>m(s,e(s).notes=d)),k("click",Be,()=>ie(`/mobile/sales/${e(U)}`)),k("click",se,je),v(t,i)};I(Ze,t=>{e(Ie)?t(et):t(tt,!1)})}r(ve);var Ce=o(ve,2);{var rt=t=>{var i=Tt(),c=a(i),g=a(c),j=a(g),f=o(a(j),2);r(j),r(g);var z=o(g,2),H=a(z);{var T=x=>{var b=Et();he(b,5,()=>e(de),we,(N,y)=>{var C=Ft(),O=a(C),X=a(O,!0);r(O);var D=o(O,2);{var Y=P=>{var S=Jt(),F=a(S,!0);r(S),w(()=>_(F,e(y).phone)),v(P,S)};I(D,P=>{e(y).phone&&P(Y)})}var J=o(D,2);{var L=P=>{var S=Lt(),F=a(S,!0);r(S),w(()=>_(F,e(y).address)),v(P,S)};I(J,P=>{e(y).address&&P(L)})}r(C),w(()=>_(X,e(y).name)),k("click",C,()=>Ke(e(y))),v(N,C)}),r(b),v(x,b)},G=x=>{var b=Vt(),N=o(a(b),2);r(b),k("click",N,()=>ie("/mobile/customers/new")),v(x,b)};I(H,x=>{e(de).length>0?x(T):x(G,!1)})}r(z),r(c),r(i),k("click",f,()=>p(ae,!1)),v(t,i)};I(Ce,t=>{e(ae)&&t(rt)})}var at=o(Ce,2);{var st=t=>{var i=Ut(),c=a(i),g=a(c),j=a(g),f=o(a(j),2);r(j),r(g);var z=o(g,2),H=a(z);{var T=x=>{var b=Qt();he(b,5,()=>e(ne),we,(N,y)=>{var C=Kt(),O=a(C),X=a(O,!0);r(O);var D=o(O,2),Y=a(D);r(D);var J=o(D,2);{var L=P=>{var S=Gt(),F=a(S);r(S),w(Z=>_(F,`规格: ${Z??""}`),[()=>e(y).specifications.map(Z=>Z.name).join(", ")]),v(P,S)};I(J,P=>{e(y).specifications&&e(y).specifications.length>0&&P(L)})}r(C),w(P=>{_(X,e(y).name),_(Y,`${e(y).unit??""} • ¥${P??""}`)},[()=>ke(e(y),"sale").toFixed(2)]),k("click",C,()=>Qe(e(y))),v(N,C)}),r(b),v(x,b)},G=x=>{var b=Rt(),N=o(a(b),2);r(b),k("click",N,()=>ie("/mobile/products/new")),v(x,b)};I(H,x=>{e(ne).length>0?x(T):x(G,!1)})}r(z),r(c),r(i),k("click",f,()=>{p(W,!1),p(A,-1)}),v(t,i)};I(at,t=>{e(W)&&t(st)})}v(Le,Se),ft(),Te()}export{vr as component};
