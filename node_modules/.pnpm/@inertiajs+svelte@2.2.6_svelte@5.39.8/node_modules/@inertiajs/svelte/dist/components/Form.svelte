<script>import {
  formDataToObject,
  resetFormFields,
  mergeDataIntoQueryString,
  isUrlMethodPair
} from "@inertiajs/core";
import { isEqual } from "lodash-es";
import { onMount } from "svelte";
import useForm from "../useForm";
const noop = () => void 0;
export let action = "";
export let method = "get";
export let headers = {};
export let queryStringArrayFormat = "brackets";
export let errorBag = null;
export let showProgress = true;
export let transform = (data) => data;
export let options = {};
export let onCancelToken = noop;
export let onBefore = noop;
export let onStart = noop;
export let onProgress = noop;
export let onFinish = noop;
export let onCancel = noop;
export let onSuccess = noop;
export let onError = noop;
export let onSubmitComplete = noop;
export let disableWhileProcessing = false;
export let invalidateCacheTags = [];
export let resetOnError = false;
export let resetOnSuccess = false;
export let setDefaultsOnSuccess = false;
const form = useForm({});
let formElement;
let isDirty = false;
let defaultData = new FormData();
$: _method = isUrlMethodPair(action) ? action.method : method.toLowerCase();
$: _action = isUrlMethodPair(action) ? action.url : action;
function getFormData() {
  return new FormData(formElement);
}
function getData() {
  return formDataToObject(getFormData());
}
function updateDirtyState(event) {
  isDirty = event.type === "reset" ? false : !isEqual(getData(), formDataToObject(defaultData));
}
export function submit() {
  const [url, _data] = mergeDataIntoQueryString(_method, _action, getData(), queryStringArrayFormat);
  const maybeReset = (resetOption) => {
    if (!resetOption) {
      return;
    }
    if (resetOption === true) {
      reset();
    } else if (resetOption.length > 0) {
      reset(...resetOption);
    }
  };
  const submitOptions = {
    headers,
    errorBag,
    showProgress,
    invalidateCacheTags,
    onCancelToken,
    onBefore,
    onStart,
    onProgress,
    onFinish,
    onCancel,
    onSuccess: (...args) => {
      if (onSuccess) {
        onSuccess(...args);
      }
      if (onSubmitComplete) {
        onSubmitComplete({
          reset,
          defaults
        });
      }
      maybeReset(resetOnSuccess);
      if (setDefaultsOnSuccess === true) {
        defaults();
      }
    },
    onError: (...args) => {
      if (onError) {
        onError(...args);
      }
      maybeReset(resetOnError);
    },
    ...options
  };
  $form.transform(() => transform(_data)).submit(_method, url, submitOptions);
}
function handleSubmit(event) {
  event.preventDefault();
  submit();
}
function handleReset(event) {
  if (event.isTrusted) {
    event.preventDefault();
    reset();
  }
}
export function reset(...fields) {
  resetFormFields(formElement, defaultData, fields);
}
export function clearErrors(...fields) {
  $form.clearErrors(...fields);
}
export function resetAndClearErrors(...fields) {
  $form.clearErrors(...fields);
  reset(...fields);
}
export function setError(field, value) {
  if (typeof field === "string") {
    $form.setError(field, value);
  } else {
    $form.setError(field);
  }
}
export function defaults() {
  defaultData = getFormData();
  isDirty = false;
}
onMount(() => {
  defaultData = getFormData();
  const formEvents = ["input", "change", "reset"];
  formEvents.forEach((e) => formElement.addEventListener(e, updateDirtyState));
  return () => {
    formEvents.forEach((e) => formElement?.removeEventListener(e, updateDirtyState));
  };
});
$: slotErrors = $form.errors;
</script>

<form
  bind:this={formElement}
  action={_action}
  method={_method}
  on:submit={handleSubmit}
  on:reset={handleReset}
  {...$$restProps}
  inert={disableWhileProcessing && $form.processing ? true : undefined}
>
  <slot
    errors={slotErrors}
    hasErrors={$form.hasErrors}
    processing={$form.processing}
    progress={$form.progress}
    wasSuccessful={$form.wasSuccessful}
    recentlySuccessful={$form.recentlySuccessful}
    {clearErrors}
    {resetAndClearErrors}
    {setError}
    {isDirty}
    {submit}
    {defaults}
  />
</form>
